'use client';

import React, { useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { usePathname, useRouter } from 'next/navigation';

import { LeagueProvider } from '@/contexts/league-context';
import { RoleProvider } from '@/contexts/role-context';
import { AppSidebar } from '@/components/app/app-sidebar';
import { AppHeader } from '@/components/app/app-header';
import { MobileBottomTabs } from '@/components/app/mobile-bottom-tabs';
import { SidebarProvider, SidebarInset } from '@/components/ui/sidebar';
import { Button } from '@/components/ui/button';
import { ArrowLeft } from 'lucide-react';



// ============================================================================
// AppLayout Component
// ============================================================================

/**
 * AppLayout - Unified layout for all user-facing pages.
 *
 * Features:
 * - Authentication check (redirects to login if not authenticated)
 * - LeagueContext and RoleContext providers
 * - Dynamic sidebar based on role/context
 * - Header with breadcrumbs and role switcher
 * - Mobile bottom tabs navigation
 * - Loading state while checking auth
 */
export default function AppLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const { data: session, status } = useSession();
  const router = useRouter();
  const pathname = usePathname();

  const backHref = React.useMemo(() => {
    if (!pathname || pathname === '/dashboard') return '/dashboard';

    const leagueMatch = pathname.match(/^\/leagues\/([^/]+)(?:\/(.*))?$/);
    if (leagueMatch) {
      const leagueId = leagueMatch[1];
      const subPath = leagueMatch[2];
      if (subPath) {
        return `/leagues/${leagueId}`;
      }
      return '/dashboard';
    }

    const segments = pathname.split('/').filter(Boolean);
    if (segments.length <= 1) return '/dashboard';
    return `/${segments.slice(0, -1).join('/')}`;
  }, [pathname]);

  const handleBackClick = React.useCallback(() => {
    if (typeof window !== 'undefined' && window.history.length > 1) {
      router.back();
      return;
    }

    router.push(backHref);
  }, [backHref, router]);

  // Redirect unauthenticated users to login
  useEffect(() => {
    if (status === 'loading') return;

    if (status === 'unauthenticated') {
      router.replace('/login?callbackUrl=/dashboard');
    }
  }, [status, router]);

  // Loading state
  if (status === 'loading') {
    return (
      <div className="min-h-svh flex items-center justify-center bg-background">
        <div className="text-center">
          <div className="size-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4" />
          <p className="text-muted-foreground">Loading...</p>
        </div>
      </div>
    );
  }

  // Don't render if not authenticated
  if (status === 'unauthenticated') {
    return null;
  }

  // Prepare user data for sidebar
  const user = {
    name: session?.user?.name || 'User',
    email: session?.user?.email || 'user@example.com',
    avatar: (session?.user as any)?.profile_picture_url || session?.user?.image || '',
  };

  return (
    <LeagueProvider>
      <RoleProvider>
        <SidebarProvider>
          {/* Sidebar - Hidden on mobile */}
          <AppSidebar user={user} className="hidden md:flex" />

          {/* Main Content Area */}
          <SidebarInset>
            {/* Header */}
            <AppHeader />

            {/* Page Content */}
            <main className="flex-1 overflow-auto pb-20 md:pb-0">
              <div className="p-4 lg:p-6">
                {pathname !== '/dashboard' && !/^\/leagues\/[^/]+$/.test(pathname || '') && !/^\/leagues\/[^/]+\/submit$/.test(pathname || '') && (
                  <Button variant="outline" size="sm" className="mb-4 gap-2" onClick={handleBackClick}>
                    <ArrowLeft className="size-4" />
                    Back
                  </Button>
                )}
                {children}
              </div>
            </main>
          </SidebarInset>

          {/* Mobile Bottom Tabs */}
          <MobileBottomTabs />
        </SidebarProvider>
      </RoleProvider>
    </LeagueProvider>
  );
}
