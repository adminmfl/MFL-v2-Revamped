import {
  LayoutDashboard,
  Trophy,
  Users,
  ClipboardCheck,
  BarChart3,
  Settings,
  Target,
  Flag,
  Shield,
  Crown,
  Dumbbell,
  Plus,
  Search,
  Activity,
  UserCheck,
  HeartHandshake,
  LucideIcon,
  BookOpen,
} from 'lucide-react';

// ============================================================================
// Types
// ============================================================================

export type LeagueRole = 'host' | 'governor' | 'captain' | 'player';

export interface NavItem {
  title: string;
  url: string;
  icon: LucideIcon;
  badge?: string;
  isActive?: boolean;
  /** If true, item is view-only (visual indicator) */
  viewOnly?: boolean;
}

export interface NavSection {
  title: string;
  items: NavItem[];
  /** Role required to see this section */
  roles?: LeagueRole[];
}

export interface SidebarConfig {
  sections: NavSection[];
}

// ============================================================================
// Base Navigation (No League Selected)
// ============================================================================

const baseNavItems: NavItem[] = [
  {
    title: 'MFL Dashboard',
    url: '/dashboard',
    icon: LayoutDashboard,
  },
  {
    title: 'Join a League',
    url: '/leagues/join',
    icon: Search,
  },

];

// ============================================================================
// Role-Based Navigation Configuration
// ============================================================================

/**
 * Get sidebar configuration based on user's role in the league
 *
 * Hierarchy:
 * - Main: Dashboard (always visible)
 * - League: Role-appropriate league features
 * - Oversight: Host/Governor submission validation
 * - My Team: Captain's team management
 * - Player: Submit activity, view team (if user is also a player)
 */
export function getSidebarNavItems(
  role: LeagueRole | null,
  leagueId: string | null,
  options?: {
    /** Whether host/governor is also participating as a player */
    isAlsoPlayer?: boolean;
  }
): NavSection[] {
  // No league selected - show base navigation
  if (!leagueId || !role) {
    return [
      {
        title: 'MyFitnessLeague',
        items: baseNavItems,
      },
    ];
  }

  const sections: NavSection[] = [];

  // Helper to build league URLs
  const leagueUrl = (path: string) => `/leagues/${leagueId}${path}`;

  // ========================================
  // PLAYER-FIRST PRIMARY Section
  // Flattened list without player/league headers
  // ========================================
  const primaryItems: NavItem[] = [
    {
      title: 'My Activities',
      url: leagueUrl(''),
      icon: Trophy,
      viewOnly: role === 'player',
    },
    {
      title: 'My Challenges',
      url: leagueUrl('/challenges'),
      icon: Flag,
      viewOnly: role === 'governor' || role === 'player',
    },
    {
      title: 'My Team',
      url: leagueUrl('/my-team-view'),
      icon: Users,
    },
    {
      title: 'Leaderboard',
      url: leagueUrl('/leaderboard'),
      icon: BarChart3,
    },
    {
      title: 'Rules',
      url: leagueUrl('/rules'),
      icon: BookOpen,
    },
  ];

  sections.push({
    title: '',
    items: primaryItems,
  });

  // ========================================
  // Host/Governor extras (keep scoped to admin section below)
  // ========================================
  const leagueAdminItems: NavItem[] = [];

  if (role === 'host') {
    leagueAdminItems.push({
      title: 'League Settings',
      url: leagueUrl('/settings'),
      icon: Settings,
    });
  }

  // ========================================
  // OVERSIGHT Section (Host & Governor)
  // For validating submissions across all teams
  // ========================================
  if (role === 'host' || role === 'governor') {
    const oversightItems: NavItem[] = [
      {
        title: 'Player Activities',
        url: leagueUrl('/submissions'),
        icon: ClipboardCheck,
      },
      {
        title: 'Configure Challenges',
        url: leagueUrl('/configure-challenges'),
        icon: Flag,
      },
      {
        title: 'Manual Workout Entry',
        url: leagueUrl('/manual-entry'),
        icon: UserCheck,
      },
      {
        title: 'Approve Donations',
        url: leagueUrl('/rest-day-donations'),
        icon: HeartHandshake,
      },
    ];


    // Include league admin items here to keep all host/governor tools together
    sections.push({
      title: 'Host/Governor Actions',
      items: [...leagueAdminItems, ...oversightItems],
    });
  }

  // ========================================
  // MY TEAM Section (Captain only)
  // Captain can only manage their own team
  // ========================================
  if (role === 'captain') {
    sections.push({
      title: 'Captain Actions',
      items: [
        {
          title: 'Team Overview',
          url: leagueUrl('/my-team'),
          icon: Users,
        },
        {
          title: 'Team Activities',
          url: leagueUrl('/my-team/submissions'),
          icon: ClipboardCheck,
        },
        {
          title: 'Approve Donations',
          url: leagueUrl('/rest-day-donations'),
          icon: HeartHandshake,
        },
      ],
    });
  }

  // ========================================
  // MAIN Section (All Roles) - At the end
  // ========================================
  sections.push({
    title: 'MyFitnessLeague',
    items: baseNavItems,
  });

  return sections;
}

// ============================================================================
// Mobile Bottom Tab Configuration
// ============================================================================

export function getMobileTabItems(
  role: LeagueRole | null,
  leagueId: string | null,
  options?: {
    isAlsoPlayer?: boolean;
  }
): NavItem[] {
  // No league - basic tabs
  if (!leagueId || !role) {
    return [
      {
        title: 'MFL Dashboard',
        url: '/dashboard',
        icon: LayoutDashboard,
      },
      {
        title: 'Leagues',
        url: '/leagues',
        icon: Trophy,
      },
      {
        title: 'Join',
        url: '/leagues/join',
        icon: Search,
      },

    ];
  }

  const leagueUrl = (path: string) => `/leagues/${leagueId}${path}`;

  // Base tabs for all roles
  const tabs: NavItem[] = [
    {
      title: 'My Activity',
      url: leagueUrl(''),
      icon: Trophy,
    },
  ];

  // Player-first tabs
  if (role === 'player') {
    tabs.push(
      {
        title: 'My Team',
        url: leagueUrl('/my-team-view'),
        icon: Users,
      },
      {
        title: 'My Challenges',
        url: leagueUrl('/challenges'),
        icon: Flag,
      }
    );
  }

  tabs.push({
    title: 'Leaderboard',
    url: leagueUrl('/leaderboard'),
    icon: BarChart3,
  });

  // Role-specific tabs
  if (role === 'host' || role === 'governor') {
    tabs.push({
      title: 'My Team',
      url: leagueUrl('/my-team-view'),
      icon: Users,
    });
    tabs.push({
      title: 'Validate',
      url: leagueUrl('/submissions'),
      icon: ClipboardCheck,
    });
  } else if (role === 'captain') {
    tabs.push({
      title: 'My Team',
      url: leagueUrl('/my-team'),
      icon: Users,
    });
    tabs.push({
      title: 'My Challenges',
      url: leagueUrl('/challenges'),
      icon: Flag,
    });
    tabs.push({
      title: 'Validate',
      url: leagueUrl('/my-team/submissions'),
      icon: ClipboardCheck,
    });
  }

  // Submit tab for players (and hosts/governors)
  const showSubmit =
    role === 'player' ||
    role === 'captain' ||
    role === 'host' ||
    role === 'governor';

  if (showSubmit) {
    tabs.push({
      title: 'Submit',
      url: leagueUrl('/submit'),
      icon: Dumbbell,
    });
  }

  // Limit to 5 tabs max for mobile
  return tabs.slice(0, 5);
}

// ============================================================================
// Helper Functions
// ============================================================================

/**
 * Check if user has elevated permissions (can manage league)
 */
export function canManageLeague(role: LeagueRole | null): boolean {
  return role === 'host' || role === 'governor';
}

/**
 * Check if user can validate submissions
 */
export function canValidateSubmissions(role: LeagueRole | null): boolean {
  return role === 'host' || role === 'governor' || role === 'captain';
}

/**
 * Check if user can access all teams (not just their own)
 */
export function canAccessAllTeams(role: LeagueRole | null): boolean {
  return role === 'host' || role === 'governor';
}

/**
 * Check if user can modify league settings
 */
export function canModifyLeagueSettings(role: LeagueRole | null): boolean {
  return role === 'host';
}

/**
 * Get role display information
 */
export function getRoleDisplay(role: LeagueRole): {
  label: string;
  icon: LucideIcon;
  color: string;
} {
  const roleConfig: Record<LeagueRole, { label: string; icon: LucideIcon; color: string }> = {
    host: {
      label: 'Host',
      icon: Crown,
      color: 'text-purple-600 bg-purple-100 dark:bg-purple-900/30',
    },
    governor: {
      label: 'Governor',
      icon: Shield,
      color: 'text-blue-600 bg-blue-100 dark:bg-blue-900/30',
    },
    captain: {
      label: 'Captain',
      icon: Target,
      color: 'text-amber-600 bg-amber-100 dark:bg-amber-900/30',
    },
    player: {
      label: 'Player',
      icon: Dumbbell,
      color: 'text-green-600 bg-green-100 dark:bg-green-900/30',
    },
  };

  return roleConfig[role];
}

export default getSidebarNavItems;
